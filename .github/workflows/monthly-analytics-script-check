name: Check Analytics Script for Changes (Monthly)

on:
  schedule:
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  check-script:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Get latest script content
        run: curl -sL "https://cloud.umami.is/script.js" > latest_script.js

      - name: Compare script content and commit on change
        run: |
          if cmp -s latest_script.js workflows/monthly-analytics-script-check/script.js; then
            echo "‚úÖ No changes detected."
          else
            echo "‚ùå Change detected. Updating script in repository."
            mv latest_script.js workflows/monthly-analytics-script-check/script.js

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            git add workflows/monthly-analytics-script-check/script.js
            git commit -m "build: update umami analytics script"
            git push
            
            echo "üîî Failing the workflow to trigger a notification."
            exit 1
          fi